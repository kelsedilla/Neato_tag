<!DOCTYPE html>
<html lang="en">
<head>
<title>Neato Tag - Content Page</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
body,h1,h2,h3,h4,h5,h6 {font-family: "Lato", sans-serif}
.w3-bar,h1,button {font-family: "Montserrat", sans-serif}
.fa-cog,.fa-code,.fa-bar-chart {font-size:200px}
</style>
</head>
<body>
<!-- Navbar -->
<div class="w3-top">
<div class="w3-bar w3-pink w3-card w3-left-align w3-large">
<a class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-right w3-padding-large w3-hover-white w3-large w3-pink" href="javascript:void(0);" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
<a href="index.html" class="w3-bar-item w3-button w3-padding-large w3-hover-white">Home</a>
<a href="system_architecture.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">System Architecture</a>
<a href="reflection.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Reflection</a>
<a href="milestone1.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Milestone 1</a>
<a href="milestone2.html" class="w3-bar-item w3-button w3-hide-small w3-padding-large w3-hover-white">Milestone 2</a>
</div>
<!-- Navbar on small screens -->
<div id="navDemo" class="w3-bar-block w3-white w3-hide w3-hide-large w3-hide-medium w3-large">
<a href="index.html" class="w3-bar-item w3-button w3-padding-large">Home</a>
<a href="milestone1.html" class="w3-bar-item w3-button w3-padding-large">Milestone 1</a>
<a href="milestone2.html" class="w3-bar-item w3-button w3-padding-large">Milestone 2</a>
</div>
</div>

<!-- Header -->
<header class="w3-container w3-pink w3-center" style="padding:128px 16px">
<h1 class="w3-margin w3-jumbo">System Architecture</h1>
<!-- <p class="w3-xlarge">Subtitle or Description</p> -->
</header>

<!-- Content Section 1 -->
<div class="w3-row-padding w3-padding-64 w3-container">
<div class="w3-content">
<div class="w3-twothird">
<h1>Overview</h1>
<h5 class="w3-padding-32">For this project, we split up into three subteams:</h5>
<h5 class="w3-padding-8"><b>Machine Vision (Brooke and Lily):</b> The machine vision subteam was focused on developing a machine vision pipeline that allows the chaser Neato to track and chase after the runner Neato.</h5>
<h5 class="w3-padding-8"><b>Localization (Tchenzie and Zara):</b> The localization subteam's goal was to create a system that allows Neatos to track their own poses within a known map and then publish those poses to each other. This allows the chaser Neato to follow the runner even when it can’t see it.</h5>
<h5 class="w3-padding-8"><b>Multi-Neato and Integration (Brenna and Kelsey):</b> The multi-Neato subteam worked on setting up the infrastructure for two Neatos to be controlled from one laptop. After achieving this they transitioned to working on integration between multi-Neato, localization, and machine vision subteams.</h5>

<h1 class="w3-padding-32">System Diagrams</h1>
<img src="images/diagram1.jpg" alt="architecture diagram" width="500" height="600"> 
<h5 class="w3-padding-8">Initially we hoped to completely integrate our machine vision and localization code together with two Neatos. Unfortunately, an unsolved error on the localization side prevented us from completing this integration. The diagram above shows our initial architecture plan for the fully integrated project.</h5>
<h5 class="w3-padding-8">Both Neato1 and Neato2 have their own particle filter node since the locations of both on the world map are needed for the chase. Both particle filters send location data of their respective Neato to the chase_logic node which calculates what direction and speed is needed for Neato1 to follow Neato2, then sends those velocity instructions to Neato1. Neato2 gets its velocity instructions from teleop, so the user can play as Neato 2 in the game of tag.</h5>
<img src="images/diagram2.jpg" alt="architecture diagram" width="500" height="600"> 
<h5 class="w3-padding-8">The diagram above shows our actual code architecture in our final project. This program switches controls between the Neatos when they tag. In each program, there is a dictionary attribute that stores which role is which neato. Upon a bump, the values swap. Blue arrows and text show the system when Neato1 is the chaser, and Neato2 is the escaper. Red shows the controls swapped. Refer to our README in our repo for a more in-depth breakdown on our logic <a href="https://github.com/kelsedilla/Neato_tag/blob/main/README.md">(README File)</a></h5>


<!-- <p class="w3-text-grey">Additional paragraphs can provide more context, technical details, challenges faced, or solutions implemented. You can include multiple paragraphs to fully explain your work.</p>
<p class="w3-text-grey">Feel free to add code snippets, algorithms, or any other relevant information that helps document your project progress.</p> -->
</div>
<div class="w3-third w3-center">
<i class="fa fa-cog w3-padding-64 w3-text-pink"></i>
</div>
</div>
</div>

<!-- Content Section 2 -->
<div class="w3-row-padding w3-light-grey w3-padding-64 w3-container">
<div class="w3-content">
<div class="w3-third w3-center">
<i class="fa fa-code w3-padding-64 w3-text-pink w3-margin-right"></i>
</div>
<div class="w3-twothird">
<h1 class="w3-padding-32">Machine Vision</h1>
<h5 class="w3-padding-8">Our original vision (ha!) for this subteam was using an algorithm like YOLO to detect another Neato and then SORT to track it. The image data would be enhanced with LIDAR, giving us the angle and distance of the other Neato. We quickly pivoted from YOLO after looking at 50 images we had taken from a Neato camera and seeing little to no contrast between another Neato and the space it’s in. We also realized that Neatos are too short to appear on LIDAR scans, and we’d need to modify them to be taller. Our solution to both of these problems was to cover the Neatos in bright pink sticky notes to increase visibility and height.</h5>
<h5 class="w3-padding-8">	Once we did this, we realized that we could use a simple color detection algorithm to create bounding boxes rather than training a YOLO model. We tested this model on images of the pink Neato, and it worked extremely well. We then adapted the Neato Soccer code from Day 14 to move the robot towards the center of a bounding box. When we tested this, we found that the program worked exactly the way we expected. The next step was to add SORT tracking, which predicts where the bounding box will be next. We found that our first implementation of this performed poorly. We expect that this is due to our tracker not realizing that our Neato is moving as well, which changes the position of the bounding box even though the other Neato may not be moving. Due to the high performance of our program without using SORT, we decided to not use tracking and just update the bounding box with the current camera frame.</h5>
</div>
</div>
</div>

<!-- Content Section 3 -->
<div class="w3-row-padding w3-padding-64 w3-container">
<div class="w3-content">
<div class="w3-twothird">
<h1>Localization</h1>
<h5 class="w3-padding-32">The localization subteam unfortunately wasn’t able to get the particle filter running on our multi-Neato setup, but these would be the steps to follow to run the multi-Neato localization.</h5>
<h5 class="w3-padding-8">The final localization system works by running a bash file “particle_filter.py”. This bash file executes 5 steps for both Neatos</h5>
<h5 class="w3-padding-8"><b>Step 1: Initiate the Neato’s using the IP address.</b></h5>
<h5 class="w3-padding-8">The terminal asks for the last 2 to 3 digits of both Neatos. After the user inputs those digits it assigns it to the end of 192.168.16.{last digits here}. The bash file assigns both running Neatos to separate terminal tabs called “First Neato” and “Second Neato”.</h5>
<h5 class="w3-padding-8"><b>Step 2: Initiate Multi-teleop for both Neatos.</b></h5>
<h5 class="w3-padding-8">Now that both Neatos are running, the bash file opens a new terminal tab called “Basic Teleop” which uses ros2 run to initiate the multi-teleop script created by the multi-neato and integration subteam.</h5>
<h5 class="w3-padding-8"><b>Step 3: Special Ros2 Config</b></h5>
<h5 class="w3-padding-8">The bash file runs a line that sets up a special config for running RViz. We found that without this line of code, the particle filter does not work for the Neato. </h5>
<h5 class="w3-padding-8"><b>Step 4: Particle Filter</b></h5>
<h5 class="w3-padding-8">The script attempts to run the particle filter for both Neatos at the same time using two separate terminal tabs called “Ros2 Particle Filter #{neato number}”. This line of code runs a built-in particle filter (AMCL) and launches the specified custom map we made in Milestone 1. </h5>
<h5 class="w3-padding-32">When running this line of code with multiple Neatos, we get the following message:</h5>
<h5 class="w3-padding-8" style="font-family:courier;">[amcl-2] [INFO] [1765823830.048684699] [neato2.amcl]: Message Filter dropping message: frame 'neato2base_laser_link' at time 1765823829.547 for reason 'the timestamp on the message is earlier than all the data in the transform cache'</h5>
<h5 class="w3-padding-8">We do not know what causes this message because the particle filter works perfectly when setup for a single Neato (as shown in Milestone 2), and rviz seems to be displaying published data correctly, indicating that there is some problem with the AMCL node.</h5>
<h5 class="w3-padding-8"><b>Steps we took to address this error</b> (none of which worked, unfortunately):</h5>
<ul>
  <li>Ensure all nodes are running on clock time, as opposed to simulation time. This is the most common cause of this error in general, but did not seem to be the cause in our case.</li>
  <li>Increase the buffer size in the AMCL node’s message queue to account for latency in the Neato’s transform publishes</li>
  <li>Consulting course assistants and our professor</li>
</ul>
<h5 class="w3-padding-8">Another step we could potentially take is re-publishing the transforms ourselves with appropriate timestamps, using a tool such as Chrony to sync the clocks between the Neato and our computers, or giving up on the AMCL particle filter entirely and using one of our own particle filters from the localization project earlier this year. Unfortunately we ran out of time to try any of these options, and had to cut our losses.</h5>
<h5 class="w3-padding-8">On the plus side, we did learn about static vs dynamic transforms, common ways to address timing synchronization issues in ROS2, and the structure of the launch files that we use to connect to the Neatos.</h5>




</h5>
</div>
<div class="w3-third w3-center">
<i class="fa fa-bar-chart w3-padding-64 w3-text-pink"></i>
</div>
</div>
</div>

<!-- Content Section 4 -->
<div class="w3-row-padding w3-light-grey w3-padding-64 w3-container">
<div class="w3-content">
<div class="w3-third w3-center">
<i class="fa fa-code w3-padding-64 w3-text-pink w3-margin-right"></i>
</div>
<div class="w3-twothird">
<h1>Multi-Neato and Integration</h1>
<h5 class="w3-padding-32">The goal of the Multi Neato subteam was to learn how to launch and control two Neatos on the same device, and to set up the publishers that would allow multiple files to interact with the Neatos. We began work early, and about halfway through the project we were able to dissolve to support the other two subteams.</h5>
<h5 class="w3-padding-8">We began by altering a simple, one Neato teleop code to control two Neatos. In order to successfully control two Neatos from one computer, each neato needs a specific namespace, which is used in all of the publishers to that Neato.</h5>
<h5 class="w3-padding-8">For example, in our teleop code we changed:</h5>
<h5 class="w3-padding-8" style="font-family:courier;">self.vel_pub = self.create_publisher(Twist, ‘cmd_vel', 10)</h5>
<h5 class="w3-padding-8">to:</h5>
<h5 class="w3-padding-8" style="font-family:courier;">self.vel_pub1 = self.create_publisher(Twist, 'namespace1\cmd_vel', 10)</h5>
<h5 class="w3-padding-8" style="font-family:courier;">self.vel_pub2 = self.create_publisher(Twist, ‘namespace2\cmd_vel', 10)</h5>
<h5 class="w3-padding-8">Similarly, To subscribe to information from a specific Neato, such as camera or lidar data, you need to use that Neato’s namespace as well.</h5>
<h5 class="w3-padding-8">Once we had successfully set up multi-Neato teleop, we began working with the localization and machine vision teams to adapt their code for multiple Neatos.</h5>
<h5 class="w3-padding-8">In our final code, the controls of the two Neatos swap when one tags the other. We achieved this by changing which namespace each control file (chase_logic.py and teleop.py) publishes to when the bump sensor is detected.</h5>


</div>
</div>
</div>

<!-- Footer -->
<div class="w3-container w3-black w3-center w3-opacity w3-padding-64">
</div>

<script>
// Used to toggle the menu on small screens when clicking on the menu button
function myFunction() {
var x = document.getElementById("navDemo");
if (x.className.indexOf("w3-show") == -1) {
x.className += " w3-show";
  } else { 
x.className = x.className.replace(" w3-show", "");
  }
}
</script>
</body>
</html>
